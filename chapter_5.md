# BOOT PROCESS

1. Electrical power flows to the components of the computer\
↓
2. The firmware ( BIOS / UEFI ) runs a POST ( Power On Self Test) & checks for essential hardware : CPU, RAM, keyboard, etc.\
↓
3. The firmware detect connected devices, test and configures (memory timings, voltage, drive controllers, etc.) hardware components.\
↓
4. The firmware looks for a boot loader (bootable device)\
↓
5. The firmware loads the bootloader from the disk to the RAM\
↓
6. The bootloader looks for a kernal\
↓
7. The bootloader loads the kernel into RAM and pass control to the kernel (kernel handoff)\
↓
8. The kernal starts the init process

---

**`dmesg `**`[option]`\
--> display kernel-related messages and diagnostics.

> **!** since, the *kernal ring buffer* is circular, new kernal messges may overwrite boot messages.

---

## FIRMWARE

**BIOS (Basic Input / Output System)**

original BIOS firmware could only read one sector of data from the hard disk.\
since this is not enought to load a full kernal, a **bootloader** program is loaded.\
the **bootloader** locate the kernal and load it to the ram.

bootloader can be stored in,
+ internal / external HD
+ CD/DVD
+ USB
+ ISO file
+ network server (NFS / HTTP / FTP)

> **!** **MBR** is the first sector of the first partition of a HD.

bootloader is not required to point to a Kernal file.\
it could point to another program of any type, including another bootloader program.

---

**UEFI (Unified Extensible Firmware Interface)**

Instead of the first sector , a full partiiton (EFI system partition) (FAT) is allocated to store bootloaders.\
UEFI firmware has a built in boot-manager to control which bootloader to run.\
each bootloader file must be registered in the boot-manager for it to appear in the boot menu.\
efi files stored in **/boot/efi/** doesn't have a fixed extention for efi files, but **.efi** is preffered.

> **!** secure boot is only loading digitally signed bootloders.\
> **!** many systems recognize only microsoft certificates.\
> **!** linux distros use **chainloading** ( using a **shim bootloader** signed by microsoft to point to the real bootloader ).

---

## BOOTLOADERS

**LILO (Linux Loader)**

- the first linux bootloader.
- doesn't support UEFI.
- config fie located at **/etc/lilo.conf**.

---

**GRUB (GRUB Legacy)**

- GRUB menu-commands are stored in --> ***/boot/grub/menu.lst***
- GRUB config file consist of 2 sections
    + global definitions
    + os boot definitions
```
    -------------- global definitions --------------

    # Set GRUB menu text and highlight colors
    color light-gray/blue

    # Set the default boot entry
    default 0

    # Fallback options if default fails
    fallback 1 2

    # Hide the boot menu unless a key is pressed
    hiddenmenu

    # Wait 5 seconds before auto-booting the default entry
    timeout 5

    # Set splash image background (must be 640x480 .xpm.gz)
    splashimage=(hd0,0)/boot/grub/splash.xpm.gz

    -------------- os boot definitions --------------

    # Entry 0: Ubuntu Linux
    title Ubuntu Linux 10.04
        # Specify boot partition
        root (hd0,0)
        kernel /boot/vmlinuz-2.6.32-21-generic root=/dev/sda1 ro quiet splash
        initrd /boot/initrd.img-2.6.32-21-generic

    # Entry 1: Windows XP
    title Windows XP
        # Use rootnoverify to avoid mounting or probing the partition
        rootnoverify (hd0,1)
        chainloader +1
```

> **!** **(hd0,0)** means first partition of first hard disk **( ie, sda1 )**.\
> **!** in **vmlinuz** the *z* means that the kernal is compressed with *bz*. uncompressed kernal is **vmlinux**. 

manually create grub config file then install it using.\
`grub-install /dev/sda` or `grub-install '(hd0)'`

to install a copy of GRUB in the **bootsector of a partition**\
instead of the **mbr of a hard disk** for *chain loading*.\
`grub-install /dev/sda2` or `grub-install '(hd0,1)'`

> no need to reinstall GRUB after config changes, since GRUB Legacy always reads *' /boot/grub/menu.lst '* at boot time.

---

**GRUB2**

GRUB 2 : configuration system has 3 files.

|Location                               |Details|
|-                                      |-|
|***/boot/grub/grub.cfg*** : (Debian) <br> ***/boot/grub2/grub.cfg*** : (RedHat)|main configuration file <br> do not edit manually <br> generated by `update-grub` or `grub-mkconfig` + `grub-install` <br> `grub-mkconfig -o /boot/grub/grub.cfg` <br> `grub-install /dev/sda3` <br> `update-grub` ( debian only ) <br> for RedHat / Fedora / etc.. use **grub2** instead of **grub** in commands <br> `grub2-mkconfig -o /boot/grub2/grub.cfg` <br> `grub2-install /dev/sda3`|
|***/etc/grub.d/***                     |contain script files that define boot menu entries <br> 10_linux --> detects installed Linux <br> 40_custom --> user-defined entries <br> etc...|
|***/etc/default/grub***                |global settings file ( default / timeout / etc... )|

*/boot/ { grub | grub2 } /grub.cfg file* :

    # Set default boot entry
    set default=0

    # Set timeout (seconds to wait before auto-booting)
    set timeout=5

    # Set menu colors
    set menu_color_normal=white/black
    set menu_color_highlight=black/light-gray

    # Entry 0: Linux
    menuentry "My Linux" {
        set root=(hd0,1)
        linux /boot/vmlinuz-linux root=/dev/sda2 ro quiet
        initrd /boot/initrd.img-linux
    }

    # Entry 1: Windows
    menuentry "Windows 10" {
        set root=(hd0,2)
        chainloader +1
    }

> **!** GRUB2 numbering starts at *1 instead of 0 for partitions*. first partition of first drive --> **(hd0,1)**

---

**ALTERNATIVE BOOTLOADERS**

| Bootloader    | Supported File System     | Notes / Details|
|-              |-                          |-|
| **SYSLINUX**  | FAT file systems          ||
| **EXTLINUX**  | EXT, Btrfs file systems   ||
| **ISOLINUX**  | ISO file systems (LiveCD) |`isolinux.bin` = bootloader <br> `isolinux.cfg` = configuration file|
| **PXELINUX**  | Network file systems      |• BOOTP (Bootstrap Protocol) is a network protocol used to automatically obtain : <br> An IP address <br> The location of a boot file <br> The IP address of the server hosting that boot file <br><br> • Boot process : <br> Getting an IP address via DHCP <br> Downloading a bootloader **/tftpboot/pxelinux.0** via **TFTP** <br> Loading a configuration file from **/tftpboot/pxelinux.cfg** <br> Booting the specified kernel or OS installer|
| **MEMDISK**   | Older DOS systems         ||

---

## SYSTEM RECOVERY

| **Failure**                           | **Troubleshooting Steps**|
|-                                      |-|
|Kernel Failures<br>**Kernel Panics**   |1. Select a previous kernel from GRUB <br> 2. Boot into **single user mode** <br> • Press **E** at GRUB menu and add `single` to the Linux line <br>3. Try passing other kernel parameters|
|Drive Failures                         | 1. Load a rescue OS (runs from RAM) <br> 2. Run `fsck /dev/sda3` to inspect/fix the drive <br> • Repeat until you get a *"clean"* result <br> • Use `-y` to auto-confirm repairs <br> 3. Mount and check contents: `mount /dev/sda3 /media`|

# STARTUP AND SERVICES

**`init`**\
--> first process ( **PID 1** ) that runs after the kernel has finished initializing the system. responsible for bootstrapping all other services.

+ Located in :
    - ***/etc/***
    - ***/bin/***
    - ***/sbin/***

+ parent process of every service.

```
    $ which init
    /sbin/init

    $ readlink -f /sbin/init
    /usr/lib/systemd/systemd

    # system is using systemd
```

---

## SYSTEMD

> **!** A **unit** in systemd defines a service, group of services or an action.

priority order when two unit files have same name,

1. /etc/systemd/system (Highest) (**update proof**)
2. /run/systemd/system
3. /usr/lib/systemd/system (Lowest)

**Unit Files**

| Extension         | Purpose|
|-                  |-|
| **.service**      | Define how a daemon or a background process should be managed <br> What executable to Start, stop, reload, enable, disable (with what arguments) <br> When (on boot)(other service start)(etc.) <br> How to manage (restart on failure)(check dependencies)(limit restarts)(etc.) <br> Under what conditions (networking is up)(etc.)|
| **.socket**       | Define socket-based activation for services, saves resources <br> Systemd listens on a socket and start the relevent service when a connection is made <br> **Activtes service of the same name, unless *Service=* option is set**|
| **.target**       | Group and coordinate other unit files to achieve a common goal <br> Boot into a specific system mode by killing / starting units as defined <br> • **graphical.target** - multiuser + GUI <br> • **multi-user.target** - multiuser <br> • **rescue.target** - singleuser(root) + all local filesystems + no networking <br> • **emergency.target** - singleuser(root) + root filesystem + no networking <br> • **reboot.target** - reboot system <br> • **poweroff.target** - shutdown system <br> • **halt.target** - halt system immediately <br> Kill / start multiple services together by making a custom target (gaming.target)|
| **.timer**        | Schedule tasks based on events or date-time similar to cron <br> **Activtes service of the same name, unless *Unit=* option is set**|
| **.mount**        | Define the mounting options of each file system <br> Systemd-native replacement for traditional entries in /etc/fstab <br> Systemd auto-generate .mount files for fstab entries <br> Enable easy control of filesystems (`$ systemctl start my-mount.mount`) <br> Dependency handling (after=network.target for NFS) <br> **Naming rule : */home/user/share/ --> home-user-share.mount***|
| **.automount**    | Automatically mount / unmount a filesystem on-demand <br> Systemd triggers `home-user-share.mount` if user accessed `/home/user/share/` <br> Automatically unmount after a specific idle seconds <br> Improves boot speed and saves resources <br> .automount must have a .mount file of the same name <br> **Naming rule : */home/user/share/ --> home-user-share.automount***|
| **.path**         | Define event-based(file system) activation for services <br> Monitor a file / directory and trigger a service when a change occurs <br> **Activtes service of the same name, unless *Unit=* option is set**|
| **.device**       | Auto-generated by systemd when the device becomes availabe <br> The unit file itself does not trigger any unit by becoming availabe <br> But the device file can referenced on another unit to trigger itself <br> Ie. auto-mount when the device become availabe <br> **Naming rule : */dev/sda1 --> dev-sda1.device***|
| **.swap**         | Define the mounting options of swap file systems, similar to **.mount** unit files <br> see **.mount** unit file|
| **.slice**        | Define resource management for groups of processes using Linux control groups (cgroups) <br> • **system.slice** - system services <br> • **user.slice** - user sessions <br> • **init.slice** - PID 1 and early boot processes <br> Limit resources for certain processes|
| **.scope**        | Define management of externally started processes (not launched by systemd) <br> Place external processes into control groups (cgroups) <br> Auto-generated by tools such as <br> • **loginctl** - user sessions <br> • **systemd-run** - manual processes <br> • **machinectl** - virtual machines or containers <br> • **desktop-environments**|
| **.snapshot**     | Capture the current state of the system’s active units <br> Restore the system to a previous state without rebooting or manually restarting services|

---

**`systemctl `**`[option] [command] [unit+++]`\
--> command-line interface to **systemd**.

| command                    | Description|
|-                          |-|
| **disable** / **enable**  | start / do not start at boot|
| **start**                 | start unit|
| **status**                | display unit current status|
|                           |**enabled** : starts automatically at boot<br>**disabled** : don't start at boot<br>**static** : The unit has no **[Install]** section and cannot be enabled directly, meant to be pulled in by other units<br>**indirect** : The unit is not enabled directly by the user, but is enabled as a dependency of another unit<br>**masked** : The unit is completely blocked, even manual starts are blocked (symlinked to **/dev/null**)<br>**generated** : The unit file was dynamically generated,Not manually manageable<br>**transient** : The unit was created at runtime. No persistence|
|                           |**enabled-runtime** : The unit is enabled for this boot session only<br>**disabled-runtime** : Explicitly disabled for this boot session only<br>**masked-runtime** : Temporarily masked for this boot session only|
| **stop**                  | stop unit|
| **restart**               | restart / start the unit|
| **mask**                  | prevent unit from starting manually or at boot<br>• `--now` to immediately enforce<br>• `--running` to enforce only unitll next reboot<br>link unit to **dev/null**|
| **unmask**                | undo mask|
| **reload**                | running service reloads its **configurations** without stopping it|
| **daemon-reload**         | systemd manager **reload unit files from disk**<br>just makes systemd aware of changes to unit file|
| **is-active**             | display active / failed|
| **is-enabled**            | display enabled / disabled|
| **is-failed**             | display active / failed|

> **!** **Vendor Preset** : A default status setting provided by the OS or package vendor.

---

**`$ systemctl is-system-running`**\
--> System Opertional Status.

| Status                    | Description|
|-                          |-|
| **running**               |system fully working|
| **degraded**              |system has failed units|
| **maintenance**           |system in emergency / recovery mode|
| **initializing**          |system is starting to boot|
| **starting**              |system is booting|
| **stopping**              |system is starting to shut down|

---

**`$ systemd-analyze `**`[option]`\
--> Analyze Units.

| Option                    | Description|
|-                          |-|
| **blame**                 | list each running unit with time taken to initialize. sorted slowest to fastest|
| **time**                  | display time spent on kernal, ramfs, user-space to initialize|
| **critical-chain**        | display time critical units in a tree format|
| **dump**                  | display info about all units|
| **verify**                | scan the unit files for errors, follows directory location precedence|
|                           | can accept a unit file name as an argument|

---

**`$ systemctl list-units`**\
--> list already loaded units.

**`$ systemctl list-unit-files`**\
--> list all unit files. 

**`$ systemctl --failed`**\
--> display a list of failed units.

**`$ systemctl get-default`**\
--> display systems default target

**`$ systemctl set-default`**\
--> set system default target.

**`$ systemctl isolate graphical.target`**\
--> stop un-nessesery units and start any additional required units for graphical.target.\
--> **.target** is optional.

! In grub2 menu targets can be set manually.\
! Press 'e' to edit the entry and add **systemd.unit=rescue.target** to the *linux* line.

---

> ***default.target***
>
> responsible for launching all the required services at system initialization.
>
>     $ find / -name default.target 2>/dev/null
>     /usr/lib/systemd/system/default.target
>
>     $ readlink -f /usr/lib/systemd/system/default.target
>     /usr/lib/systemd/system/graphical.target
>
>     -----------------------------------------------------
>
>     $ systemctl get-default
>     graphical.target

---

### UNIT FILE STRUCTURE

    [Unit]
    
    # UNIT SPECIFIC SECTIONS
    [Service]
    [Mount]
    [Automount]
    [Timer]
    [etc...]

    [Install]


***[Unit]*** --> Metadata and dependency controls

| Option            | Description |
|-                  |-|
| Description=      | One-line human-readable description of the unit|
| Documentation=    | List of URIs, for documentation|
| Requires=         | X is required to start this unit|
| Wants=            | X is required but, this unit starts even X fails|
| Before=           | Start this unit before starting X (not a dependency)|
| After=            | Start this unit after starting X (not a dependency)|
| Conflicts=        | If X is running, this unit will be stopped (and vice versa)|
| BindsTo=          | X is required to start this unit, if X stops for any reason, this unit stops|

---

***[Install]*** --> Enabling / Disabling behavior

| Option            | Description |
|-                  |-|
| WantedBy=         | Specifies one or more targets this unit should be wanted by when enabled|
| RequiredBy=       | Required dependency instead of wanted, when the target is started, this unit must start|
| Alias=            | Defines additional names (aliases) for the unit <br> Aliases create additional symlinks pointing to this unit|
| Also=             | When enabling this unit, also enable the units listed here|

---

***[Service]***

| Option                        | Description |
|-                              |-|
|Type=                          | ExecStart / ExecStartPre / ExecStartPost execution type|
|                               |• **simple** (default) – the started process is the main process<br>• **forking** – systemd expects the process to fork; the child becomes the main service<br>• **oneshot** – for short-lived commands; supports multiple ExecStart= lines executed sequentially<br>• **idle** – delays execution until all currently queued jobs finish<br>• **dbus** – waits until a specific D-Bus name is acquired<br>• **notify** – waits for an explicit readiness signal|
| ExecStart=                    | command or script to run|
| ExecStartPre=                 | commands run before the *ExecStart=* <br> if fail, *ExecStart=* will not start <br> may appear multiple times|
| ExecStartPost=                | commands run after the *ExecStart=* <br> if fail, doesn't affect *ExecStart=* <br> may appear multiple times|
| ExecStop=                     | command or script to run at the end of the service|
| ExecStopPost=                 | command or script to run at the **end / fail** of the service|
| ExecReload=                   | Commands run when reloading the service|
| Restart=                      | restarting the service on exit or failure|
|                               |• **no** (default)<br>• **on-failure**<br>• **on-abnormal**<br>• **on-watchdog**<br>• **on-abort**<br>• **always**|
| RestartSec=                   | Delay between service exit and restart|
| RemainAfterExit=              | For **Type=oneshot**, marks the service active even after the command exits|
| Environment=                  | Set environment variables inline<br>Multiple lines are allowed|
| EnvironmentFile=              | Load variables from an external file|

---

***[Mount]***

| Option                        | Description |
|-                              |-|
| What=	                        | Absolute path to the source to mount|
| Where=	                    | Absolute path of the mount point directory<br>If doesn't exist, will be created|
| Type=                         | (optional) File system type|
| Options=                      | (optional) Comma-separated mount options|
| SloppyOptions=                | (optional) Unknown options in **Options=** are tolerated rather than causing errors|
| DirectoryMode=                | (optional) Sets the octal permission mode used when creating the mount point directory<br>And any needed parent directories (**default 0755**)|
| TimeoutSec=                   | (optional) Maximum time to wait for **mount / unmount operations**<br>If exeeded processes are terminated with **SIGTERM** and eventually **SIGKILL**|

---

***[Automount]***

| Option                        | Description |
|-                              |-|
| Where=                        | Absolute path that triggers the automount when accessed|
| DirectoryMode=                | (optional) Permissions for auto-created directory (**default 0755**)|
| TimeoutIdleSec=               | (optional) Idle time before automatic unmount (**default 0**)|

> **!** Let systemd manage dependencies automatically.\
> **!** Put any dependencies (After/Wants/etc...) in the companion .mount file, **not in .automount**.

---

***[Timer]***

| Option                | Description |
|-                      |-|
| OnActiveSec=          | Time after timer activation|
| OnBootSec=            | Time after boot|
| OnStartupSec=         | Time after systemd startup|
| OnCalendar=           | Real-time date-time schedule|
| AccuracySec=          | Trigger time window (default 1min)|
| Unit=                 | Unit to fire|
| Persistent=           | Run missed events after downtime|
| WakeSystem=           | Wake system from suspend|
| RemainAfterElapse=    | Unit remain loaded after timer elapsed|

---

## SysV

> **!** instead of targets, **SysV** uses **run levels**

|DEBIAN     |REDHAT ||
|-          |-      |-|
|0          |0      | shutdown|
|1          |1,s,S  | single-user|
|           |2      | multi-user without networking|
|           |3      | multi-user + text|
|           |4      | custom level|
|2          |5      | multi-user + GUI|
|6          |6      | reboot|

    $ runlevel
    N   2

    # runlevel shows ( previous ) and ( current ) runlevels.
    # N for newly booted.

> **!** In sysV `/etc/inittab` file **was used** to start services\
> **!** But later it has been used to **set system run level** and start terminal services.

    $ grep :initdefault: /etc/inittab
    id:5:initdefault:

| Feature               | Debian            | Red Hat               | Notes|
|-                      |-                  |-                      |-|
| **init directory**    | `/etc/init.d/`    | `/etc/rc.d/init.d/`   |Each service must have a initialization script loaded in **init directory**<br>( **\*** ) indicates that they are executable bash scripts|
| **rc directory**      | `/etc/rcX.d/`     | `/etc/rc.d/rcX.d/`    |each run level (X) has its own directory<br>each runlevel directory has symbolic links of service initialization scripts from **init directory**|
| **rc script**         | `/etc/init.d/rc`  | `/etc/rc.d/rc`        |**rc script** executes the initializtion scripts in the relevant (run-level) **rc directory**|
| **rc.local**          | `/etc/rc.local`   | `/etc/rc.d/rc.local`  |**rc.local** script allows adding additional scripts to be run after system initialization|

**`$ init 3` / `$ telinit 3`**\
--> switch run level.

**rc directory** example,

    $ ls /etc/rc.d/rc3.d

    K01smolt@
    K02avahi-dnsconfd@
    ...
    K99readahead_later@
    S00microde_ctl@
    S04readahead_early@
    ...
    S55cups@

> **K** = KILL\
> **S** = START\
> **00-99** = the number indicate the order to kill or start service\
> **@** = symbolic link

> **rc** script run through all the kill scripts first then start scripts, allowing switching between run levels on the fly.

**`$ service `**`[service] [option]`\
--> Manage services.

| Option    | Description|
|-          |-|
|restart    |restart the service<br>if not running already, display **failed** but start the service|
|start      |start the service|
|status     |show status|
|stop       |stop service|
|reload     |load config file of running service, fails if service is not running|

**`$chkconfig`**`[option] [service] [command]`\
--> Manage which services start with each run level ( **REDHAT** ).

|Command                        | Description |
|-                              |-|
|chkconfig cups                 |check if 'cups' is enabled at current run level<br>**echo $?** must be issues immediately after to view result(1/0)|
|chkconfig cups on              |enable 'cups' on current run level|
|chkconfig cups off             |disable 'cups' on current run level|
|chkconfig --add cups           |enable cups on all run levels|
|chkconfig --del cups           |disable 'cups' on all run levels|
|chkconfig --level 35 cups on   |enable 'cups' on levels 3 and 5|
|chkconfig --level 35 cups off  |disable 'cups' on levels 3 and 5|
|chkconfig --list cups          |show status of 'cups' on each run level|

**`$update-rc.d`**`[option] [service] [command]`\
--> Manage which services start with each run level ( **DEBIAN** ).

|Command                                            | Description |
|-                                                  |-|
|update-rc.d cups defaults                          |start cups with default runlevel|
|update-rc.d cups remove                            |remove 'cups' from starting with default runlevel|
|update-rc.d -f cups start 55 2 3 . stop 80 0 1 6   |Create start symlinks with priority 55 for runlevels 2 and 3<br>Create stop symlinks with priority 80 for runlevels 0, 1, and 6|
